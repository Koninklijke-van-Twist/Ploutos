name: Deploy to FTP on master push

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Debug env
        run: |
          echo "Host: $FTP_HOST"
          echo "User: $FTP_USERNAME"
          # echo "Pass: $FTP_PASSWORD"  # liever niet loggen ðŸ˜‰
          echo "Remote dir: $FTP_REMOTE_DIR"
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}

      # Stap 1: alles op de server opruimen behalve .htaccess, .htpasswd, *.json, auth.php
      - name: Deploy web/ to FTP (with delete & excludes)
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_HOST" << EOF
          set cmd:fail-exit true
          set net:max-retries 1
          set net:timeout 20
          set ftp:ssl-allow false
          set ftp:passive-mode yes

          cd "$FTP_REMOTE_DIR"

          mirror -R --delete \
            --exclude-glob .htaccess \
            --exclude-glob cache/** \
            --exclude-glob feestdagen/** \
            --exclude-glob .htpasswd \
            --exclude-glob *.json \
            --exclude-glob auth.php \
            ./web .

          bye
          EOF
